<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Chase | B-BOX Games</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background-color: #050505;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            font-family: 'Poppins', sans-serif;
        }

        .navbar { flex-shrink: 0; }

        #game-wrapper {
            flex-grow: 1;
            position: relative;
            background: #111;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        #score-display {
            position: absolute;
            top: 20px;
            font-size: 40px;
            font-weight: 900;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            z-index: 20;
        }

        .msg-box {
            background: rgba(10, 5, 20, 0.95);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid #00fff2;
            text-align: center;
            box-shadow: 0 0 40px rgba(0, 255, 242, 0.3);
            pointer-events: auto;
            backdrop-filter: blur(10px);
        }

        h2 { color: #00fff2; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #aaa; margin: 0 0 20px 0; }

        button.play-btn {
            background: linear-gradient(45deg, #00fff2, #0088ff);
            border: none;
            padding: 12px 30px;
            color: #000;
            font-weight: bold;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 0 15px rgba(0, 255, 242, 0.5);
        }
        button.play-btn:hover { transform: scale(1.05); }

        /* CONTROLES MÓVILES (Joystick Invisible) */
        #touch-zone {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5;
        }
        .controls-hint {
            position: absolute; bottom: 20px; color: rgba(255,255,255,0.5); font-size: 12px;
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html" class="logo-text">B-BOX <span>GAMES</span></a>
            </div>
            <nav class="nav-links">
                <a href="index.html">Volver</a>
                <div id="user-area" style="display: inline-block; margin-left: 20px;">
                    <div id="userInfo" style="display: none; align-items: center; gap: 10px;">
                        <img id="userPhoto" src="" alt="User" style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid #00fff2;">
                        <span id="userName" style="color: #fff; font-weight: 600;"></span>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div id="game-wrapper">
        <div id="score-display">0</div>
        <canvas id="gameCanvas"></canvas>
        <div id="touch-zone"></div>
        
        <div id="ui-layer">
            <div id="start-screen" class="msg-box">
                <h2>Neon Chase</h2>
                <p>Escapa de la policía. <br>Usa FLECHAS o TOCA los lados.</p>
                <button class="play-btn" onclick="startGame()">CONDUCIR</button>
            </div>
            
            <div id="game-over-screen" class="msg-box" style="display: none;">
                <h2 style="color: #ff4757;">ARRESTADO</h2>
                <p>Tiempo: <span id="final-score" style="color: #fff; font-weight: bold;">0</span> seg</p>
                <button class="play-btn" style="background: #ff4757; color: white;" onclick="resetGame()">HUIR OTRA VEZ</button>
            </div>
            
            <div class="controls-hint" id="pc-hint">← Izquierda | Derecha →</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score-display');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreEl = document.getElementById('final-score');

        let isRunning = false;
        let isGameOver = false;
        let score = 0;
        let frames = 0;
        
        // Configuración de Pantalla
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 70; // Restar navbar
        }
        window.addEventListener('resize', resize);
        resize();

        // JUGADOR (El Coche)
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            maxSpeed: 6,
            acceleration: 0.2,
            turnSpeed: 0.08,
            friction: 0.96,
            width: 20,
            height: 34,
            color: '#00fff2',
            trail: []
        };

        const police = [];
        const policeSpeed = 3.5;

        // INPUTS
        const keys = { left: false, right: false };

        // Teclado
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
            if(e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
            if(e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
        });

        // Táctil (Izquierda / Derecha de la pantalla)
        const touchZone = document.getElementById('touch-zone');
        touchZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            if (touchX < window.innerWidth / 2) {
                keys.left = true; keys.right = false;
            } else {
                keys.right = true; keys.left = false;
            }
        });
        touchZone.addEventListener('touchend', (e) => {
            e.preventDefault();
            keys.left = false; keys.right = false;
        });

        // --- LÓGICA DEL JUEGO ---

        function update() {
            if (!isRunning) return;

            // 1. Físicas del Jugador
            if (keys.left) player.angle -= player.turnSpeed;
            if (keys.right) player.angle += player.turnSpeed;

            // Aceleración automática constante (como Escape Road)
            if (player.speed < player.maxSpeed) player.speed += player.acceleration;
            
            // Movimiento basado en ángulo (Derrape simple)
            player.x += Math.cos(player.angle) * player.speed;
            player.y += Math.sin(player.angle) * player.speed;

            // Límites (Rebotar en bordes)
            if (player.x < 0 || player.x > canvas.width) {
                player.angle = Math.PI - player.angle;
                player.x = Math.max(0, Math.min(canvas.width, player.x));
            }
            if (player.y < 0 || player.y > canvas.height) {
                player.angle = -player.angle;
                player.y = Math.max(0, Math.min(canvas.height, player.y));
            }

            // Rastro de derrape
            if (frames % 3 === 0) {
                player.trail.push({ x: player.x, y: player.y, alpha: 1 });
                if (player.trail.length > 20) player.trail.shift();
            }

            // 2. Enemigos (Policía)
            // Spawnear cada 2 segundos aprox
            if (frames % 120 === 0) {
                spawnPolice();
            }

            for (let i = 0; i < police.length; i++) {
                let cop = police[i];
                
                // IA: Perseguir jugador
                let dx = player.x - cop.x;
                let dy = player.y - cop.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                let angleToPlayer = Math.atan2(dy, dx);

                cop.x += Math.cos(angleToPlayer) * policeSpeed;
                cop.y += Math.sin(angleToPlayer) * policeSpeed;
                cop.angle = angleToPlayer;

                // Colisión Jugador vs Policía
                if (dist < 25) { // Radio de colisión simple
                    gameOver();
                }

                // Colisión Policía vs Policía (Choque)
                for (let j = i + 1; j < police.length; j++) {
                    let otherCop = police[j];
                    let dxg = cop.x - otherCop.x;
                    let dyg = cop.y - otherCop.y;
                    let distg = Math.sqrt(dxg*dxg + dyg*dyg);
                    
                    if (distg < 25) {
                        // Explotan ambos
                        createExplosion((cop.x + otherCop.x)/2, (cop.y + otherCop.y)/2);
                        police.splice(j, 1);
                        police.splice(i, 1);
                        score += 5; // Puntos extra por hacer que choquen
                        scoreEl.innerText = score;
                        i--; // Ajustar índice
                        break;
                    }
                }
            }

            // Puntuación por tiempo (sobrevivir)
            if (frames % 60 === 0) {
                score++;
                scoreEl.innerText = score;
            }

            frames++;
        }

        let particles = [];
        function createExplosion(x, y) {
            for(let i=0; i<10; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: '#ff4757'
                });
            }
        }

        function draw() {
            // Fondo con rastro suave
            ctx.fillStyle = 'rgba(10, 10, 16, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Rejilla de suelo
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            let gridSize = 50;
            // Efecto de movimiento en la rejilla (opcional, aquí estática para rendimiento)
            for(let x=0; x<canvas.width; x+=gridSize) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
            for(let y=0; y<canvas.height; y+=gridSize) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

            // Dibujar Rastro Jugador
            player.trail.forEach(t => {
                t.alpha -= 0.05;
                ctx.fillStyle = `rgba(0, 255, 242, ${t.alpha})`;
                ctx.fillRect(t.x-5, t.y-5, 10, 10);
            });

            // Dibujar Jugador
            drawCar(player.x, player.y, player.angle, player.color);

            // Dibujar Policías
            police.forEach(cop => {
                drawCar(cop.x, cop.y, cop.angle, '#ff4757');
                // Sirena
                if(frames % 20 < 10) {
                    ctx.fillStyle = 'blue';
                    ctx.beginPath(); ctx.arc(cop.x, cop.y, 5, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.fillStyle = 'red';
                    ctx.beginPath(); ctx.arc(cop.x, cop.y, 5, 0, Math.PI*2); ctx.fill();
                }
            });

            // Partículas
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawCar(x, y, angle, color) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            // Sombra
            ctx.shadowColor = color;
            ctx.shadowBlur = 15;

            // Cuerpo del auto
            ctx.fillStyle = color;
            ctx.fillRect(-10, -17, 20, 34);
            
            // Parabrisas
            ctx.fillStyle = '#000';
            ctx.fillRect(-8, -5, 16, 8);
            
            ctx.shadowBlur = 0;
            ctx.restore();
        }

        function spawnPolice() {
            // Spawnear en los bordes aleatorios
            let x, y;
            if(Math.random() > 0.5) {
                x = Math.random() > 0.5 ? -20 : canvas.width + 20;
                y = Math.random() * canvas.height;
            } else {
                x = Math.random() * canvas.width;
                y = Math.random() > 0.5 ? -20 : canvas.height + 20;
            }
            police.push({ x: x, y: y, angle: 0 });
        }

        function loop() {
            update();
            draw();
            if(isRunning) requestAnimationFrame(loop);
        }

        function startGame() {
            startScreen.style.display = 'none';
            score = 0;
            frames = 0;
            player.x = canvas.width/2;
            player.y = canvas.height/2;
            player.angle = 0;
            player.speed = 0;
            police.length = 0;
            particles = [];
            isRunning = true;
            isGameOver = false;
            loop();
        }

        function gameOver() {
            isRunning = false;
            isGameOver = true;
            finalScoreEl.innerText = score;
            gameOverScreen.style.display = 'block';
            
            if(window.guardarPuntaje) window.guardarPuntaje("Neon Chase", score);
        }

        function resetGame() {
            gameOverScreen.style.display = 'none';
            startGame();
        }

        // Render inicial
        draw();

    </script>

    <script type="module" src="script.js"></script>

</body>
</html>
